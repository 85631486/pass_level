# å¯è§†åŒ–ç¼–è¾‘å™¨è®¾è®¡æ–¹æ¡ˆï¼šMDç”Ÿæˆåçš„ç¼–è¾‘å·¥ä½œæµ

## ğŸ“‹ é—®é¢˜æ ¸å¿ƒ

**æŒ‘æˆ˜**ï¼šMD â†’ JSON â†’ å‰ç«¯é¡µé¢ç”Ÿæˆåï¼Œæ•™å¸ˆéœ€è¦èƒ½å¤Ÿï¼š
1. âœ… ä¿®æ”¹é¡µé¢å¸ƒå±€å’Œæ ·å¼
2. âœ… ç¼–è¾‘æ­¥éª¤å†…å®¹å’Œé¡ºåº
3. âœ… ä¿®æ”¹é¢˜åº“å’Œç­”æ¡ˆ
4. âœ… è°ƒæ•´æ¸¸æˆåŒ–é…ç½®
5. âœ… ä¿æŒä¸MDçš„åŒæ­¥ï¼ˆå¯é€‰ï¼‰

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **æ‰€è§å³æ‰€å¾—**ï¼šæ•™å¸ˆå¯ä»¥ç›´æ¥åœ¨é¢„è§ˆé¡µé¢ä¸Šç¼–è¾‘
2. **åˆ†å±‚ç¼–è¾‘**ï¼šæ”¯æŒä¸åŒå±‚çº§çš„ç¼–è¾‘ï¼ˆå¸ƒå±€ã€å†…å®¹ã€æ•°æ®ï¼‰
3. **æ•°æ®æŒä¹…åŒ–**ï¼šæ‰€æœ‰ä¿®æ”¹ä¿å­˜åˆ°æ•°æ®åº“
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒMDå’ŒJSONçš„åŒå‘åŒæ­¥
5. **æ˜“ç”¨æ€§**ï¼šéæŠ€æœ¯äººå‘˜ä¹Ÿèƒ½è½»æ¾ä½¿ç”¨

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡ï¼šä¸‰å±‚ç¼–è¾‘ç³»ç»Ÿ

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ•™å¸ˆç¼–è¾‘å·¥ä½œæµ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  MDæºæ–‡ä»¶  â†â†’  JSONæ•°æ®  â†â†’  å‰ç«¯é¡µé¢    â”‚
â”‚     â†‘              â†‘              â†‘      â”‚
â”‚     â”‚              â”‚              â”‚      â”‚
â”‚  æ–‡æœ¬ç¼–è¾‘      å¯è§†åŒ–ç¼–è¾‘      é¢„è§ˆç¼–è¾‘   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®å­˜å‚¨ç­–ç•¥

```typescript
// æ•°æ®åº“æ¨¡å‹æ‰©å±•
interface Level {
  id: number
  name: string
  
  // æºæ•°æ®ï¼ˆMDï¼‰
  teaching_guide_md: string  // åŸå§‹MDå†…å®¹
  
  // ç”Ÿæˆæ•°æ®ï¼ˆJSONï¼‰
  course_data_json: string    // ç”Ÿæˆçš„JSONï¼ˆå¯ç¼–è¾‘ï¼‰
  
  // å…ƒæ•°æ®
  last_md_sync: Date         // æœ€åä¸€æ¬¡ä»MDåŒæ­¥çš„æ—¶é—´
  last_json_edit: Date        // æœ€åä¸€æ¬¡JSONç¼–è¾‘çš„æ—¶é—´
  edit_mode: 'md' | 'json'   // å½“å‰ç¼–è¾‘æ¨¡å¼
  
  // ç‰ˆæœ¬å†å²
  version_history: Array<{
    version: number
    type: 'md' | 'json'
    content: string
    timestamp: Date
    author: number
  }>
}
```

---

## ğŸ¨ æ–¹æ¡ˆä¸€ï¼šå¯è§†åŒ–ç¼–è¾‘å™¨ï¼ˆæ¨èï¼‰

### 1.1 ç¼–è¾‘å™¨ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…³å¡ç¼–è¾‘å™¨ - å¯è§†åŒ–æ¨¡å¼                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                                  â”‚               â”‚
â”‚  ç»„ä»¶åº“  â”‚        ç”»å¸ƒåŒºåŸŸï¼ˆå¯ç¼–è¾‘ï¼‰          â”‚   å±æ€§é¢æ¿    â”‚
â”‚          â”‚                                  â”‚               â”‚
â”‚  ğŸ“ æ–‡æœ¬ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  å½“å‰é€‰ä¸­ï¼š   â”‚
â”‚  ğŸ¯ é¢˜ç›® â”‚  â”‚  æ­¥éª¤1: æ•°æ®åŠ è½½          â”‚   â”‚  æ­¥éª¤1        â”‚
â”‚  ğŸ’» ä»£ç  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚               â”‚
â”‚  ğŸ¬ è§†é¢‘ â”‚  â”‚  â”‚ ä»£ç ç¼–è¾‘å™¨ç»„ä»¶     â”‚  â”‚   â”‚  æ ‡é¢˜: [ç¼–è¾‘]  â”‚
â”‚  ğŸ¨ ç»˜å›¾ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  å†…å®¹: [ç¼–è¾‘]  â”‚
â”‚  ğŸ“Š å›¾è¡¨ â”‚  â”‚                          â”‚   â”‚  éš¾åº¦: â­â­â­  â”‚
â”‚  ğŸ® æ¸¸æˆ â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  å¥–åŠ±: [ç¼–è¾‘]  â”‚
â”‚          â”‚  â”‚  â”‚ é¢˜ç›®ç»„ä»¶           â”‚  â”‚   â”‚               â”‚
â”‚  [æ‹–æ‹½]  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  [ä¿å­˜]        â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚               â”‚
â”‚          â”‚                                  â”‚               â”‚
â”‚          â”‚  [æ·»åŠ æ­¥éª¤] [ä¸Šç§»] [ä¸‹ç§»] [åˆ é™¤] â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶å®ç°

#### å¯è§†åŒ–ç¼–è¾‘å™¨ä¸»ç»„ä»¶

```vue
<!-- components/VisualCourseEditor.vue -->
<template>
  <div class="visual-editor">
    <!-- å·¥å…·æ  -->
    <div class="editor-toolbar">
      <div class="toolbar-left">
        <button @click="toggleMode('preview')">ğŸ‘ï¸ é¢„è§ˆ</button>
        <button @click="toggleMode('edit')">âœï¸ ç¼–è¾‘</button>
        <button @click="saveChanges">ğŸ’¾ ä¿å­˜</button>
        <button @click="syncToMD">ğŸ”„ åŒæ­¥åˆ°MD</button>
      </div>
      <div class="toolbar-right">
        <button @click="undo">â†¶ æ’¤é”€</button>
        <button @click="redo">â†· é‡åš</button>
        <button @click="preview">ğŸŒ é¢„è§ˆ</button>
      </div>
    </div>

    <!-- ä¸»ç¼–è¾‘åŒº -->
    <div class="editor-body">
      <!-- å·¦ä¾§ï¼šç»„ä»¶åº“ -->
      <aside class="component-library">
        <h3>ç»„ä»¶åº“</h3>
        <draggable
          v-model="componentList"
          :options="{ group: { name: 'components', pull: 'clone', put: false } }"
        >
          <div
            v-for="comp in componentList"
            :key="comp.type"
            class="component-item"
          >
            <span class="icon">{{ comp.icon }}</span>
            <span class="name">{{ comp.name }}</span>
          </div>
        </draggable>
      </aside>

      <!-- ä¸­é—´ï¼šç”»å¸ƒ -->
      <main class="canvas-area">
        <div
          v-for="(step, stepIdx) in courseData.steps"
          :key="step.id"
          class="step-container"
          :class="{ selected: selectedStepId === step.id }"
          @click="selectStep(step.id)"
        >
          <!-- æ­¥éª¤å¤´éƒ¨ -->
          <div class="step-header">
            <span class="step-number">æ­¥éª¤ {{ stepIdx + 1 }}</span>
            <input
              v-model="step.title"
              class="step-title-input"
              placeholder="æ­¥éª¤æ ‡é¢˜"
            />
            <div class="step-actions">
              <button @click="moveStep(stepIdx, 'up')">â†‘</button>
              <button @click="moveStep(stepIdx, 'down')">â†“</button>
              <button @click="deleteStep(stepIdx)">ğŸ—‘ï¸</button>
            </div>
          </div>

          <!-- æ­¥éª¤å†…å®¹åŒºåŸŸï¼ˆå¯æ‹–æ‹½ç»„ä»¶ï¼‰ -->
          <div class="step-content-area">
            <draggable
              v-model="step.components"
              group="components"
              @add="onComponentAdd($event, step.id)"
            >
              <component
                v-for="(comp, compIdx) in step.components"
                :key="comp.id"
                :is="getComponentName(comp.type)"
                :config="comp.config"
                :editable="true"
                @update:config="updateComponentConfig(step.id, compIdx, $event)"
                @delete="deleteComponent(step.id, compIdx)"
              />
            </draggable>

            <!-- æ·»åŠ ç»„ä»¶æŒ‰é’® -->
            <div class="add-component-btn" @click="showComponentMenu(step.id)">
              + æ·»åŠ ç»„ä»¶
            </div>
          </div>
        </div>

        <!-- æ·»åŠ æ­¥éª¤æŒ‰é’® -->
        <button class="add-step-btn" @click="addNewStep">
          + æ·»åŠ æ–°æ­¥éª¤
        </button>
      </main>

      <!-- å³ä¾§ï¼šå±æ€§é¢æ¿ -->
      <aside class="property-panel">
        <div v-if="selectedComponent">
          <h3>ç¼–è¾‘ç»„ä»¶</h3>
          <component
            :is="getPropertyEditorName(selectedComponent.type)"
            :config="selectedComponent.config"
            @update:config="updateSelectedComponentConfig"
          />
        </div>
        <div v-else-if="selectedStep">
          <h3>ç¼–è¾‘æ­¥éª¤</h3>
          <StepPropertyEditor
            :step="selectedStep"
            @update:step="updateStep"
          />
        </div>
        <div v-else>
          <p>é€‰æ‹©ä¸€ä¸ªæ­¥éª¤æˆ–ç»„ä»¶è¿›è¡Œç¼–è¾‘</p>
        </div>
      </aside>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import draggable from 'vuedraggable'
import type { CourseData, CourseStep } from '../types/coursePlayer'

// ç»„ä»¶åº“å®šä¹‰
const componentList = [
  { type: 'text', name: 'æ–‡æœ¬', icon: 'ğŸ“' },
  { type: 'code', name: 'ä»£ç ç¼–è¾‘å™¨', icon: 'ğŸ’»' },
  { type: 'quiz', name: 'é¢˜ç›®', icon: 'ğŸ¯' },
  { type: 'video', name: 'è§†é¢‘', icon: 'ğŸ¬' },
  { type: 'image', name: 'å›¾ç‰‡', icon: 'ğŸ–¼ï¸' },
  { type: 'drawing', name: 'ç»˜å›¾', icon: 'ğŸ¨' },
  { type: 'dragdrop', name: 'æ‹–æ‹½æ’åº', icon: 'ğŸ”„' },
]

const courseData = ref<CourseData>({
  steps: []
})

const selectedStepId = ref<string | null>(null)
const selectedComponent = ref<any>(null)

const selectedStep = computed(() => {
  if (!selectedStepId.value) return null
  return courseData.value.steps.find(s => s.id === selectedStepId.value)
})

// ç»„ä»¶æ–¹æ³•
function selectStep(stepId: string) {
  selectedStepId.value = stepId
  selectedComponent.value = null
}

function addNewStep() {
  const newStep: CourseStep = {
    id: `step-${Date.now()}`,
    type: 'content',
    title: 'æ–°æ­¥éª¤',
    components: []
  }
  courseData.value.steps.push(newStep)
  selectStep(newStep.id)
}

function onComponentAdd(event: any, stepId: string) {
  const step = courseData.value.steps.find(s => s.id === stepId)
  if (!step) return
  
  const newComponent = {
    id: `comp-${Date.now()}`,
    type: event.item.dataset.type,
    config: getDefaultConfig(event.item.dataset.type)
  }
  
  // æ·»åŠ åˆ°æ­¥éª¤çš„componentsæ•°ç»„
  if (!step.components) step.components = []
  step.components.push(newComponent)
}

function updateComponentConfig(stepId: string, compIdx: number, config: any) {
  const step = courseData.value.steps.find(s => s.id === stepId)
  if (step && step.components) {
    step.components[compIdx].config = config
  }
}

function saveChanges() {
  // ä¿å­˜åˆ°åç«¯
  // POST /api/v1/levels/:id/course-data
}

function syncToMD() {
  // å°†JSONè½¬æ¢å›MDï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
  // POST /api/v1/ai-assistant/course-json-to-md
}
</script>
```

#### æ­¥éª¤å±æ€§ç¼–è¾‘å™¨

```vue
<!-- components/StepPropertyEditor.vue -->
<template>
  <div class="step-property-editor">
    <div class="form-group">
      <label>æ­¥éª¤æ ‡é¢˜</label>
      <input v-model="localStep.title" />
    </div>

    <div class="form-group">
      <label>æ­¥éª¤ç±»å‹</label>
      <select v-model="localStep.type">
        <option value="content">å†…å®¹</option>
        <option value="quiz">æµ‹éªŒ</option>
        <option value="operation">æ“ä½œ</option>
        <option value="summary">æ€»ç»“</option>
      </select>
    </div>

    <div class="form-group">
      <label>å»ºè®®ç”¨æ—¶</label>
      <input v-model="localStep.duration" placeholder="å¦‚ï¼š10åˆ†é’Ÿ" />
    </div>

    <div class="form-group">
      <label>éš¾åº¦ç­‰çº§</label>
      <div class="star-rating">
        <span
          v-for="i in 5"
          :key="i"
          class="star"
          :class="{ active: i <= localStep.difficulty }"
          @click="localStep.difficulty = i"
        >
          â­
        </span>
      </div>
    </div>

    <div class="form-group">
      <label>å®Œæˆå¥–åŠ±</label>
      <div class="reward-inputs">
        <input
          v-model.number="localStep.rewards.exp"
          type="number"
          placeholder="ç»éªŒå€¼"
        />
        <input
          v-model.number="localStep.rewards.coins"
          type="number"
          placeholder="é‡‘å¸"
        />
      </div>
    </div>

    <div class="form-group">
      <label>çŸ¥è¯†å¡ç‰‡</label>
      <button @click="editKnowledgeCard">ç¼–è¾‘çŸ¥è¯†å¡ç‰‡</button>
    </div>

    <div class="form-actions">
      <button @click="save">ä¿å­˜</button>
      <button @click="cancel">å–æ¶ˆ</button>
    </div>
  </div>
</template>
```

---

## ğŸ¨ æ–¹æ¡ˆäºŒï¼šåˆ†å±‚ç¼–è¾‘æ¨¡å¼

### 2.1 ä¸‰ç§ç¼–è¾‘æ¨¡å¼

```typescript
// ç¼–è¾‘æ¨¡å¼æšä¸¾
enum EditMode {
  LAYOUT = 'layout',    // å¸ƒå±€ç¼–è¾‘ï¼šæ‹–æ‹½ã€æ’åºã€æ ·å¼
  CONTENT = 'content',  // å†…å®¹ç¼–è¾‘ï¼šæ–‡æœ¬ã€é¢˜ç›®ã€ç­”æ¡ˆ
  DATA = 'data'         // æ•°æ®ç¼–è¾‘ï¼šJSONç›´æ¥ç¼–è¾‘
}
```

### 2.2 æ¨¡å¼åˆ‡æ¢ç•Œé¢

```vue
<!-- components/MultiModeEditor.vue -->
<template>
  <div class="multi-mode-editor">
    <!-- æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ -->
    <div class="mode-tabs">
      <button
        v-for="mode in modes"
        :key="mode.value"
        :class="{ active: currentMode === mode.value }"
        @click="switchMode(mode.value)"
      >
        {{ mode.icon }} {{ mode.label }}
      </button>
    </div>

    <!-- æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒç¼–è¾‘å™¨ -->
    <VisualEditor v-if="currentMode === 'layout'" :course-data="courseData" />
    <ContentEditor v-if="currentMode === 'content'" :course-data="courseData" />
    <JsonEditor v-if="currentMode === 'data'" :course-data="courseData" />
  </div>
</template>
```

---

## ğŸ¨ æ–¹æ¡ˆä¸‰ï¼šå†…è”ç¼–è¾‘ï¼ˆæœ€ç®€å•ï¼‰

### 3.1 åœ¨é¢„è§ˆé¡µé¢ç›´æ¥ç¼–è¾‘

```vue
<!-- components/EditablePreview.vue -->
<template>
  <div class="editable-preview">
    <!-- ç¼–è¾‘æ¨¡å¼å¼€å…³ -->
    <div class="edit-toggle">
      <button @click="editMode = !editMode">
        {{ editMode ? 'é€€å‡ºç¼–è¾‘' : 'è¿›å…¥ç¼–è¾‘' }}
      </button>
    </div>

    <!-- ä½¿ç”¨ç°æœ‰çš„ LevelInteractivePlayerï¼Œä½†æ·»åŠ ç¼–è¾‘èƒ½åŠ› -->
    <LevelInteractivePlayer
      :course-data="courseData"
      :edit-mode="editMode"
      @update:step="handleStepUpdate"
      @update:question="handleQuestionUpdate"
    />
  </div>
</template>
```

### 3.2 åœ¨æ’­æ”¾å™¨ä¸­æ·»åŠ ç¼–è¾‘èƒ½åŠ›

```vue
<!-- åœ¨ LevelInteractivePlayer.vue ä¸­æ·»åŠ  -->
<template>
  <div class="level-player">
    <!-- æ­¥éª¤å†…å®¹åŒºåŸŸ -->
    <section class="step-content">
      <!-- ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºç¼–è¾‘æŒ‰é’® -->
      <button
        v-if="editMode"
        class="edit-btn"
        @click="editStepContent"
      >
        âœï¸ ç¼–è¾‘
      </button>

      <!-- å†…å®¹æ˜¾ç¤º/ç¼–è¾‘ -->
      <div v-if="!isEditing" v-html="currentStepContent"></div>
      <MarkdownEditor
        v-else
        v-model="editingContent"
        @save="saveStepContent"
        @cancel="cancelEdit"
      />
    </section>

    <!-- é¢˜ç›®ç¼–è¾‘ -->
    <section v-if="currentStep.questions" class="quiz-section">
      <div
        v-for="(question, qIdx) in currentStep.questions"
        :key="question.id"
        class="quiz-item"
      >
        <!-- ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºç¼–è¾‘æŒ‰é’® -->
        <button
          v-if="editMode"
          class="edit-btn"
          @click="editQuestion(qIdx)"
        >
          âœï¸
        </button>

        <!-- é¢˜ç›®æ˜¾ç¤º/ç¼–è¾‘ -->
        <QuestionEditor
          v-if="editingQuestionIdx === qIdx"
          :question="question"
          @save="saveQuestion"
          @cancel="cancelQuestionEdit"
        />
        <div v-else>
          <!-- æ­£å¸¸æ˜¾ç¤º -->
        </div>
      </div>
    </section>
  </div>
</template>
```

---

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ

### åç«¯APIè®¾è®¡

```python
# backend/app/api/routes/levels.py

@levels_bp.route("/<int:level_id>/course-data", methods=["GET"])
@login_required
def get_course_data(level_id: int):
    """è·å–å…³å¡çš„è¯¾ç¨‹æ•°æ®ï¼ˆJSONï¼‰"""
    level = LevelService.get_level(db, level_id)
    if not level:
        return jsonify({"detail": "å…³å¡ä¸å­˜åœ¨"}), 404
    
    # å¦‚æœæœ‰ä¿å­˜çš„JSONï¼Œè¿”å›JSONï¼›å¦åˆ™ä»MDç”Ÿæˆ
    if level.course_data_json:
        return jsonify(json.loads(level.course_data_json)), 200
    elif level.teaching_guide_md:
        # å®æ—¶ç”Ÿæˆ
        ai_service = AIService(db)
        course_data = ai_service.teaching_guide_to_course_json(level.teaching_guide_md)
        return jsonify(course_data), 200
    else:
        return jsonify({"steps": []}), 200


@levels_bp.route("/<int:level_id>/course-data", methods=["PUT"])
@login_required
def update_course_data(level_id: int):
    """æ›´æ–°å…³å¡çš„è¯¾ç¨‹æ•°æ®ï¼ˆJSONï¼‰"""
    data = request.get_json()
    if not data:
        return jsonify({"detail": "Request body is required"}), 400
    
    level = LevelService.get_level(db, level_id)
    if not level:
        return jsonify({"detail": "å…³å¡ä¸å­˜åœ¨"}), 404
    
    # ä¿å­˜JSONæ•°æ®
    level.course_data_json = json.dumps(data, ensure_ascii=False)
    level.last_json_edit = datetime.utcnow()
    level.edit_mode = 'json'
    
    db.commit()
    return jsonify({"detail": "ä¿å­˜æˆåŠŸ"}), 200


@levels_bp.route("/<int:level_id>/sync-md", methods=["POST"])
@login_required
def sync_to_md(level_id: int):
    """å°†JSONæ•°æ®åŒæ­¥å›MDï¼ˆå¯é€‰åŠŸèƒ½ï¼‰"""
    level = LevelService.get_level(db, level_id)
    if not level:
        return jsonify({"detail": "å…³å¡ä¸å­˜åœ¨"}), 404
    
    if not level.course_data_json:
        return jsonify({"detail": "æ²¡æœ‰å¯åŒæ­¥çš„JSONæ•°æ®"}), 400
    
    # è°ƒç”¨AIå°†JSONè½¬å›MD
    ai_service = AIService(db)
    course_data = json.loads(level.course_data_json)
    md_content = ai_service.course_json_to_md(course_data)
    
    # æ›´æ–°MDï¼ˆå¯é€‰ï¼šåˆ›å»ºæ–°ç‰ˆæœ¬è€Œä¸æ˜¯è¦†ç›–ï¼‰
    level.teaching_guide_md = md_content
    level.last_md_sync = datetime.utcnow()
    
    db.commit()
    return jsonify({"md": md_content}), 200
```

### æ•°æ®åº“è¿ç§»

```python
# backend/scripts/migrate_add_course_data.py

def upgrade():
    op.add_column('levels', sa.Column('course_data_json', sa.Text(), nullable=True))
    op.add_column('levels', sa.Column('last_md_sync', sa.DateTime(), nullable=True))
    op.add_column('levels', sa.Column('last_json_edit', sa.DateTime(), nullable=True))
    op.add_column('levels', sa.Column('edit_mode', sa.String(10), nullable=True))
```

---

## ğŸ”„ å·¥ä½œæµè®¾è®¡

### æ ‡å‡†å·¥ä½œæµ

```
1. æ•™å¸ˆç¼–å†™MDæ•™æ¡ˆ
   â†“
2. ç‚¹å‡»"ç”Ÿæˆäº¤äº’JSON"
   â†“
3. ç³»ç»Ÿç”ŸæˆJSONå¹¶ä¿å­˜åˆ° course_data_json
   â†“
4. æ•™å¸ˆè¿›å…¥"å¯è§†åŒ–ç¼–è¾‘å™¨"
   â†“
5. æ•™å¸ˆç¼–è¾‘å¸ƒå±€ã€å†…å®¹ã€é¢˜ç›®
   â†“
6. ç‚¹å‡»"ä¿å­˜"ï¼Œæ›´æ–° course_data_json
   â†“
7. å­¦ç”Ÿç«¯è¯»å– course_data_json æ˜¾ç¤º
```

### åŒå‘åŒæ­¥å·¥ä½œæµï¼ˆå¯é€‰ï¼‰

```
MDä¿®æ”¹ â†’ ç”ŸæˆJSON â†’ åˆå¹¶å·²æœ‰ç¼–è¾‘ â†’ ä¿å­˜
JSONä¿®æ”¹ â†’ åŒæ­¥å›MD â†’ æ›´æ–°MDï¼ˆå¯é€‰ï¼‰
```

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šåŸºç¡€ç¼–è¾‘ï¼ˆ1-2å‘¨ï¼‰
1. âœ… æ·»åŠ  `course_data_json` å­—æ®µåˆ°æ•°æ®åº“
2. âœ… å®ç° JSON çš„ä¿å­˜å’Œè¯»å– API
3. âœ… åœ¨ LevelEditor ä¸­æ·»åŠ "å¯è§†åŒ–ç¼–è¾‘"æŒ‰é’®
4. âœ… å®ç°ç®€å•çš„æ­¥éª¤ç¼–è¾‘ï¼ˆæ ‡é¢˜ã€å†…å®¹ã€é¢˜ç›®ï¼‰

### é˜¶æ®µäºŒï¼šå¯è§†åŒ–ç¼–è¾‘ï¼ˆ2-3å‘¨ï¼‰
1. âœ… å®ç°å¯è§†åŒ–ç¼–è¾‘å™¨ä¸»ç•Œé¢
2. âœ… å®ç°ç»„ä»¶æ‹–æ‹½åŠŸèƒ½
3. âœ… å®ç°å±æ€§é¢æ¿ç¼–è¾‘
4. âœ… å®ç°æ­¥éª¤çš„å¢åˆ æ”¹æŸ¥

### é˜¶æ®µä¸‰ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ3-4å‘¨ï¼‰
1. âœ… å®ç°å†…è”ç¼–è¾‘ï¼ˆåœ¨é¢„è§ˆé¡µé¢ç›´æ¥ç¼–è¾‘ï¼‰
2. âœ… å®ç°æ’¤é”€/é‡åšåŠŸèƒ½
3. âœ… å®ç°ç‰ˆæœ¬å†å²
4. âœ… å®ç°JSONåˆ°MDçš„åŒæ­¥ï¼ˆå¯é€‰ï¼‰

---

## ğŸ’¡ å…³é”®è®¾è®¡å†³ç­–

### 1. æ•°æ®æºä¼˜å…ˆçº§

```
å­¦ç”Ÿç«¯è¯»å–ä¼˜å…ˆçº§ï¼š
1. course_data_jsonï¼ˆå¦‚æœå­˜åœ¨ä¸”æœ€æ–°ï¼‰
2. ä» teaching_guide_md å®æ—¶ç”Ÿæˆ
```

### 2. ç¼–è¾‘å†²çªå¤„ç†

- **ç­–ç•¥1**ï¼šJSONç¼–è¾‘åï¼ŒMDç¼–è¾‘ä¼šè¦†ç›–JSONï¼ˆéœ€è¦ç¡®è®¤ï¼‰
- **ç­–ç•¥2**ï¼šJSONå’ŒMDç‹¬ç«‹ï¼Œæ•™å¸ˆé€‰æ‹©ä½¿ç”¨å“ªä¸ª
- **æ¨è**ï¼šç­–ç•¥2ï¼Œä½†æä¾›"ä»MDé‡æ–°ç”Ÿæˆ"æŒ‰é’®

### 3. ç‰ˆæœ¬ç®¡ç†

```typescript
// æ¯æ¬¡ä¿å­˜åˆ›å»ºç‰ˆæœ¬
interface Version {
  id: number
  level_id: number
  type: 'md' | 'json'
  content: string
  created_at: Date
  created_by: number
  note?: string  // ç‰ˆæœ¬å¤‡æ³¨
}
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç¡®å®šæ–¹æ¡ˆ**ï¼šé€‰æ‹©å¯è§†åŒ–ç¼–è¾‘å™¨ã€åˆ†å±‚ç¼–è¾‘ï¼Œè¿˜æ˜¯å†…è”ç¼–è¾‘ï¼Ÿ
2. **æ•°æ®åº“è¿ç§»**ï¼šæ·»åŠ  `course_data_json` å­—æ®µ
3. **APIå®ç°**ï¼šå®ç°ä¿å­˜å’Œè¯»å–æ¥å£
4. **å‰ç«¯å®ç°**ï¼šå®ç°ç¼–è¾‘å™¨ç•Œé¢
5. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿ç¼–è¾‘åçš„æ•°æ®èƒ½æ­£ç¡®æ˜¾ç¤º

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025-01-XX  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ

