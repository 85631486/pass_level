## 1. 文档概述

- **文档名称**：过关斩将-游戏教学平台系统详细设计  
- **版本**：V1.0  
- **依据**：平台概要设计、功能详细设计、学生端游戏化功能设计方案  
- **目标**：在 Python + Vue + SQLite 技术架构下，定义系统架构、模块实现、数据结构与接口，指导研发落地。

## 2. 技术架构

### 2.1 总体架构

```
┌──────────────┐      ┌───────────────────┐      ┌──────────────┐
│    前端 H5    │<---->│   REST/GraphQL API │<---->│ SQLite 数据库 │
│(Vue3 + TS +   │      │(Python FastAPI)   │      │  + 文件存储   │
│  Vite + PWA)  │      └───────────────────┘      └──────────────┘
│  │            │              │ │                         │
│  └>静态资源   │              │ └─ Redis(可选)            │
└──────────────┘              │     缓存/排行榜           │
                              └─ 对象存储(视频/附件)
```

- **前端**：Vue3 + TypeScript + Pinia 状态管理，Vite 构建，支持 PWA / 移动端适配。  
- **后端**：Python（FastAPI + SQLAlchemy），分层结构（API 层、Service 层、DAO 层）。  
- **数据库**：SQLite 作为嵌入式关系库，用于课程、任务、用户等核心数据。  
- **文件/媒体**：本地文件系统或对象存储（MinIO/OSS）保存视频、提交物。  
- **缓存（可选）**：Redis 提升排行榜、会话、验证码性能，后续可替换。  
- **消息与推送**：基于 WebSocket/Server-Sent Events 实现课堂实时推送。

### 2.2 部署拓扑（开发/试点）

- **本地/试点**：Nginx 反向代理 + Uvicorn（FastAPI）+ SQLite 文件。  
- **目录**：  
  - `/frontend` Vue 工程；  
  - `/backend` FastAPI 服务；  
  - `/storage/uploads` 提交物；`/storage/media` 视频；  
  - `/data/ggzj.db` SQLite 数据文件。  
- **环境**：Python 3.11，Node 18+，SQLite 3。

## 3. 模块详细设计

### 3.1 课程管理模块

- **前端组件**：`CourseList.vue`、`CourseForm.vue`、`ClassBindingDrawer.vue`、`CourseMapEditor.vue`。  
- **后端服务**：`CourseService`（课程/地图 CRUD）、`ClassService`（班级绑定）、`TemplateService`。  
- **关键流程**：  
  1. 教师访问课程列表 API `GET /courses?teacher_id=`，支持展示任务量、学生数、完成率与战斗力均值。  
  2. 新建课程 `POST /courses`，基础信息之外可选择地图模板、视觉主题。  
  3. 班级绑定 `POST /courses/{id}/classes`，生成邀请码、二维码或导入名单；支持设置助教权限。  
  4. 地图编辑 `PUT /courses/{id}/map`：拖拽任务节点、设定前置关系、隐藏副本、剧情描述、BOSS 外观。  
  5. 模板管理：导入官方模板或将现有课程另存为模板，供后续活动快速复用。  
- **校验**：课程名称、学期、班级覆盖范围必填；地图 DAG 必须无环；隐藏副本需绑定触发条件。  
- **SQLite 表**：`courses`、`classes`, `course_class_rel`, `course_maps`, `course_templates`.  

### 3.2 任务编排模块

- **前端**：`TaskEditor.vue`（多步骤 Form Wizard）、`ResourceUploader.vue`、`QuestionPicker.vue`、`BossConfigurator.vue`、`ScriptEditor.vue`。  
- **后端**：`TaskService`、`TaskStepService`、`TaskResourceService`、`AssessmentService`、`BossConfigService`、`StoryService`。  
- **流程**：  
  - 创建任务 `POST /courses/{id}/tasks`，设定章节、难度、技能收益。  
  - 上传资源 `POST /tasks/{id}/resources`，支持版本与审批。  
  - 配置步骤 `PUT /tasks/{id}/steps`，每步定义提交方式、检查点，与功能设计 3.2 对齐。  
  - 关联题目 `POST /tasks/{id}/assessments` 或引用题库。  
  - BOSS 战参数 `POST /tasks/{id}/boss-config`：题组阶段、血量比例、失败惩罚、可用道具。  
  - 剧情脚本 `POST /tasks/{id}/storyline`：NPC 对话、过场动画、彩蛋。  
- **业务规则**：  
  - 每任务至少一个资源、一个步骤、一道考题；  
  - 可设置前置任务 ID，系统校验 DAG 无环；  
  - 任务可绑定隐藏条件（每日任务、活动）；  
  - 编辑历史存储在 `task_versions`，支持回滚与对比。  
- **数据落地**：新增 `task_boss_configs`、`task_storylines` 表。

### 3.3 发布与通知模块

- **前端**：`PublishPanel.vue`、`LiveControlBar.vue`，支持定时、课堂即时发布、活动联动。  
- **后端**：`PublishService`、`NotificationService`、`SchedulerService`。  
- **流程**：  
  1. 选择任务/活动与班级，设定开放/截止时间、可见范围、过期策略。  
  2. `POST /tasks/{id}/publish` 创建记录，可绑定课堂直播场次，生成预警与提醒。  
  3. 调度器（APScheduler）监听定时任务，更新任务状态、触发消息推送，课堂界面可即时发布/撤回并记录操作日志。  
  4. 通知通道：站内信、邮件、短信、企业微信/钉钉机器人、班级大厅公告。  
- **扩展**：发布面板允许附带奖励加成（如暴击模式）、赠送道具、定向提醒未参与学生。  
- **数据表**：`task_publish_records`、`live_sessions`、`notifications`、`notification_channels`.  

### 3.4 学生任务中心与游戏化表现模块

- **前端**：`StudentDashboard.vue`、`WorldMap.vue`、`ChapterTimeline.vue`、`TaskDetailStudent.vue`、`SubmissionPanel.vue`、`BossBattle.vue`、`BattleReport.vue`。  
- **后端**：`StudentTaskService`、`SubmissionService`、`RewardService`、`MapService`、`BattleService`。  
- **核心体验**：  
  - **世界地图**：`MapService` 根据课程-任务拓扑生成章节地图，节点状态（未解锁/可挑战/已通关/隐藏副本）通过 API `GET /students/{id}/map` 返回，并携带奖励、技能收益、剧情提示。  
  - **剧情驱动任务详情**：任务详情 API 返回剧情简介、BOSS 形象、首通奖励、可使用道具列表。  
  - **BOSS 战流程**：客观题阶段以回合制形式呈现，主观题阶段触发“终结技”；`BattleService` 负责回合动画逻辑与提示卡、复活卡的消耗校验。  
- **实时排行榜视图**：仪表盘右侧提供课程/班级排行榜组件，使用 WebSocket 渠道 `ws://.../leaderboards/live?course=` 推送最新排名、战斗力与星级数据，学生可在不刷新页面的情况下查看变化并快速跳转到对应同学档案。
- **流程**：  
  1. 学生进入仪表盘，加载世界地图与待办任务；  
  2. 选择关卡后查看任务详情，系统提示对应技能提升；  
  3. 看视频/阅读文档时可触发“知识弹题”小游戏（由前端组件 `KnowledgePopQuiz` 实现，后台记录完成情况）；  
  4. 过程提交与以往相同，但 UI 以“制作装备/收集素材”形式呈现，并允许分步保存草稿；  
  5. 过关考题= BOSS 战，多阶段题组，期间可使用道具，失败可消耗复活卡重试（次数、冷却由任务配置决定）；  
  6. 结算界面展示经验、技能点、金币、星级、剧情解锁等奖励，生成战报供分享。  
- **断点续做**：  
  - 地图进度、战斗阶段状态写入 `student_battle_progress`，重新登录可无缝恢复；  
  - 提交草稿仍存于 `submission_drafts`，并记录“装备制作阶段”。  
- **社交入口**：任务详情集成“求助/助攻”入口，可跳转到小队大厅。

### 3.5 题库与判题模块

- **前端**：`QuestionBank.vue`、`QuestionEditor.vue`。  
- **后端**：`QuestionService`、`JudgeService`。  
- **题型**：单选、多选、判断、填空、简答、编程（可选），使用 `question_type` 字段。  
- **判题策略**：  
  - 客观题：前端提交答案数组，后台基于题目元数据自动判分；  
  - 主观题：生成待批阅记录 `subjective_reviews`，教师批阅后写入成绩；  
  - 编程题（可选）：调用沙箱服务。  

### 3.6 激励、角色养成与社交模块

- **前端**：`ProfilePanel.vue`、`AvatarCustomizer.vue`、`SkillTree.vue`、`RewardPopup.vue`、`Leaderboard.vue`、`SquadHall.vue`、`AssistCenter.vue`、`AchievementWall.vue`。  
- **后端**：`GamificationService`、`SkillService`、`InventoryService`、`TeamService`、`AssistService`。  
- **角色养成**：  
  - 角色数据（头像、称号、装备皮肤）由 `student_profiles`、`student_inventory` 维护；  
  - 技能树结构来自 `skill_nodes` + `skill_relations`，学生技能进度存于 `student_skills`，API `GET /students/{id}/skills` 返回雷达图数据；  
  - 战斗力指数 API 计算：`battle_power = base(level) + Σ(skill_level * weight) + star_score + assist_score`。  
- **奖励与道具**：  
  - 奖励类型扩展至经验、技能点、金币、徽章、剧情解锁、皮肤，道具（提示卡、时间冻结卡、复活卡、助力卡）由 `InventoryService` 管理；  
  - 宝箱机制记录在 `loot_chests`，包含触发条件与随机掉落权重；  
  - 每日/成长任务配置 `daily_quests`、`season_quests`，完成后触发奖励，并与教师端活动策划器、课堂直播掉落联动；  
  - 道具背包与积分商城由 `InventoryService` + `ShopService` 管理，支持课堂特权、皮肤、实体奖品兑换。  
- **排行榜与赛季**：  
  - 支持个人榜、小队榜、赛季榜；  
  - 赛季信息存于 `seasons` 表，赛季结算写快照至 `leaderboard_snapshots` 并发放赛季奖励；  
  - `LeaderboardService` 维护 Redis Sorted Set（或内存缓存）并通过 WebSocket 将实时排名推送到学生端，若缓存不可用则回退到轮询 API。
- **社交与协作**：  
  - 小队/公会：`teams`、`team_members` 表；  
  - 求助/助攻：`assist_requests`、`assist_records`，助攻加贡献值与徽章；  
  - 班级大厅支持公告、互动贴，数据表 `class_feeds`，并可展示教师端置顶战报/公告。  
- **成就系统**：`achievements`、`student_achievements`，配合 `AchievementWall.vue` 展示，可由教师端自定义条件和奖励。  
- **运营活动**：主题周、副本活动通过 `events` + `event_tasks` 实现，前端以 Banner/副本入口呈现，支持赛季通行证（SeasonPass）进度展示。  
- **直播联动**：学生端实时接收课堂直播面板触发的限时挑战、随机掉落、Buff，与 `LiveControlService` 消息通道对接。

### 3.7 数据分析模块

- **前端**：`CourseDashboard.vue`、`StudentReport.vue`、`AlertCenter.vue`、`GamificationInsights.vue`。  
- **后端**：`AnalyticsService`，通过定时任务聚合统计到 `analytics_metrics`、`gamification_metrics`。  
- **指标**：完成率、平均用时、知识点掌握度、题目正确率、告警记录、技能点成长曲线、道具使用频率、助攻响应率、世界地图热力、赛季参与度、任务漏斗、活动参与率。  
- **导出**：`GET /analytics/export?format=csv`；支持将战报/成长报告导出 PDF，并生成课堂战报 PPT。  
- **实验能力**：AB 测试框架对不同班级/奖励策略进行分组，比较 `gamification_metrics` 差异并给教师端提供建议。

### 3.8 系统管理模块

- **前端**：`AdminLayout.vue`、`UserRoleManager.vue`、`PermissionMatrix.vue`、`ResourceAudit.vue`。  
- **后端**：`AdminService`、`AuthService`、`AuditService`。  
- **功能**：用户/角色管理、权限策略（按模块、课程、功能粒度）、资源审核（视频/剧情脚本/任务模板）、日志审计（奖励公式变更、活动发布、课堂直播操作）、统一认证配置、第三方消息渠道管理。  
- **安全**：关键操作需二次确认+审批流，所有变更写入 `admin_audit_logs` 并支持回滚。

### 3.9 活动与运营模块（新增）

- **前端**：`EventCenter.vue`、`SeasonPass.vue`、`DailyQuestPlanner.vue`、`TreasureHunt.vue`。  
- **后端**：`EventService`、`SeasonService`、`QuestService`、`RewardPoolService`。  
- **功能**：  
  - 管理赛季（名称、时间、奖励、排行榜指标），配置赛季任务、通行证奖励、荣耀保留策略；  
  - 活动策划器：图形化配置副本、主题周、打卡赛、任务创作大赛，多阶段规则、报名条件、奖励包；  
  - 每日/成长任务生成：支持自动刷新、定时推送，与学生端每日挑战同步；  
  - 实体奖励库存管理：录入奖品、库存、兑换码、发放状态；  
  - 与课堂直播联动，可在活动中嵌入限时挑战、Buff；  
  - 监控活动参与率、奖励消耗、助攻活跃度，可导出报表并支持 AB 测试。  
- **数据表**：`events`、`event_tasks`、`event_rewards`、`daily_quests`、`season_quests`、`reward_pools`、`physical_prizes`。

- **前端**：`AdminLayout.vue`、`UserRoleManager.vue`、`ResourceAudit.vue`。  
- **后端**：`AdminService`、`AuthService`。  
- **功能**：用户/角色、权限策略（RBAC）、资源审核、统一认证配置、系统参数。  
- **权限模型**：`users`、`roles`、`permissions`、`user_role_rel`、`role_permission_rel`。

## 4. 数据库设计（SQLite）

### 4.1 主要表

| 表名 | 关键字段 | 描述 |
| --- | --- | --- |
| `users` | id, name, role, email, password_hash, avatar | 用户基础信息 |
| `courses` | id, name, term, teacher_id, cover, status | 课程 |
| `classes` | id, name, grade, major | 班级 |
| `course_class_rel` | id, course_id, class_id | 课程-班级关系 |
| `course_maps` | id, course_id, map_json, theme, version | 课程地图结构 |
| `course_templates` | id, name, scope, payload_json | 课程/任务模板 |
| `tasks` | id, course_id, name, difficulty, target, prereq_task_id | 任务 |
| `task_resources` | id, task_id, type, url, duration, requirement | 资源 |
| `task_steps` | id, task_id, title, description, submission_type, required | 任务步骤 |
| `questions` | id, type, content, options, answer, knowledge_tag, difficulty | 题库 |
| `task_question_rel` | id, task_id, question_id, weight | 任务与题目 |
| `task_boss_configs` | id, task_id, phases_json, hp_curve, failure_rule | BOSS 配置 |
| `task_storylines` | id, task_id, script_json, npc_refs | 剧情脚本 |
| `task_publish_records` | id, task_id, class_id, start_time, end_time, status | 发布记录 |
| `live_sessions` | id, course_id, task_id, start_time, status | 课堂直播 |
| `notification_channels` | id, type, config_json, enabled | 通知通道 |
| `submissions` | id, task_id, student_id, step_id, content_path, status | 提交 |
| `student_task_records` | id, task_id, student_id, score, status, star, attempts | 闯关记录 |
| `student_profiles` | id, student_id, avatar, title, skin_config | 角色外观 |
| `student_map_progress` | id, student_id, task_id, node_state | 地图节点状态 |
| `student_battle_progress` | id, student_id, task_id, phase_state, remaining_items | 战斗过程存档 |
| `rewards` | id, student_id, type, value, metadata | 奖励日志 |
| `loot_chests` | id, task_id, condition, drop_table_json | 宝箱配置 |
| `items` | id, code, name, type, effect_json | 道具 |
| `student_inventory` | id, student_id, item_id, quantity, expire_at | 背包 |
| `shop_items` | id, name, cost, stock, reward_json | 商城物品 |
| `skill_nodes` | id, name, description, max_level | 技能节点 |
| `skill_relations` | parent_id, child_id, unlock_rule | 技能树结构 |
| `student_skills` | id, student_id, skill_id, level, exp | 技能成长 |
| `seasons` | id, name, start_at, end_at, reward_json | 赛季 |
| `leaderboard_snapshots` | id, course_id, type, data_json, generated_at | 排行榜 |
| `teams` | id, course_id, name, badge | 小队信息 |
| `team_members` | id, team_id, student_id, role, contribution | 小队成员 |
| `assist_requests` | id, task_id, student_id, step_id, content, status | 求助记录 |
| `assist_records` | id, request_id, helper_id, result, reward | 助攻记录 |
| `achievements` | id, code, name, condition_json, reward_json | 成就配置 |
| `student_achievements` | id, student_id, achievement_id, earned_at | 成就获取 |
| `class_feeds` | id, class_id, poster_id, content, media_path | 班级大厅动态 |
| `events` | id, name, type, start_at, end_at, config_json | 活动 |
| `event_tasks` | id, event_id, task_id, bonus_json | 活动关联 |
| `event_rewards` | id, event_id, reward_pool_id, drop_rule | 活动奖励 |
| `reward_pools` | id, name, type, entries_json | 奖励池 |
| `physical_prizes` | id, name, quantity, status | 实体奖励 |
| `daily_quests` | id, course_id, config_json, refresh_rule | 每日任务配置 |
| `season_quests` | id, season_id, config_json | 赛季任务 |
| `student_quests` | id, student_id, quest_id, progress, status | 学生任务记录 |
| `notifications` | id, user_id, title, content, status | 通知 |
| `analytics_metrics` | id, course_id, metric_type, value, date | 指标 |
| `gamification_metrics` | id, course_id, metric_type, value, date | 游戏化指标 |
| `admin_audit_logs` | id, operator_id, action, payload_json, created_at | 审计日志 |

> 复杂字段（如 `options`, `data_json`）采用 JSON 存储（SQLite JSON1 扩展）。

### 4.2 数据库约束

- 外键启用：`PRAGMA foreign_keys = ON;`  
- 关键字段索引：课程、任务、学生任务记录、题库标签。  
- 版本记录（如 `task_versions`）保留 JSON 差异字段用于回滚。  
- 对高频写表（如 `student_inventory`、`assist_requests`、`student_quests`）建立联合索引；`course_maps`、`task_boss_configs` 需启用 JSON 索引提升脚本查询性能。

## 5. 接口设计（示例）

### 5.1 认证

- `POST /auth/login`：账号密码登录，返回 JWT；  
- `POST /auth/refresh`：刷新 token；  
- `POST /auth/logout`：注销。

### 5.2 课程/任务

- `GET /courses`：按角色返回可见课程；  
- `POST /courses`：创建课程；  
- `GET /courses/{id}/map` / `PUT /courses/{id}/map`：获取/更新课程地图；  
- `GET /courses/{id}/tasks`：任务列表；  
- `POST /tasks` / `PUT /tasks/{id}`：创建/更新任务；  
- `POST /tasks/{id}/boss-config`、`POST /tasks/{id}/storyline`；  
- `POST /tasks/{id}/duplicate`：模板化复制；  
- `GET /templates?type=course|task`：模板中心；  
- `POST /tasks/{id}/publish`：发布；  
- `GET /students/{id}/tasks`：学生待办。

### 5.3 学生端

- `GET /students/{id}/map`：返回闯关地图节点；  
- `GET /tasks/{id}/detail?student_id=`：任务详情（包含资源、步骤、奖励）；  
- `POST /tasks/{id}/submissions`：提交过程材料（multipart/form-data）；  
- `POST /tasks/{id}/assessments/submit`：提交答题；  
- `GET /students/{id}/profile`：角色成长信息；  
- `GET /students/{id}/rewards`：奖励历史；  
- `GET /students/{id}/battle-state?task_id=`：战斗进度；  
- `POST /students/{id}/battle-state/restore`：恢复战斗。

### 5.4 激励与社交

- `GET /students/{id}/character` / `PUT /students/{id}/character`：角色外观、称号、装备；  
- `GET /students/{id}/skills`：技能树数据；  
- `GET /students/{id}/inventory`：道具背包；  
- `POST /rewards/use-item`：道具使用（含场景校验）；  
- `GET /leaderboards?course_id=&type=`：排行榜；  
- `WS /leaderboards/live?course_id=&type=`：实时排行榜推送；  
- `POST /teams`、`POST /teams/{id}/join`、`POST /teams/{id}/leave`；  
- `GET /teams/{id}`：小队信息；  
- `POST /assist/requests`：发起求助；  
- `POST /assist/requests/{id}/reply`：助攻；  
- `GET /assist/requests?task_id=`：查看任务求助；  
- `GET /achievements` / `GET /students/{id}/achievements`；  
- `GET /events` / `GET /events/{id}`：活动详情；  
- `POST /events/{id}/claim`：活动奖励领取。
- 教师端专属：  
  - `POST /rewards/formula` / `GET /rewards/formula`：配置/获取奖励公式；  
  - `POST /items` / `PUT /items/{id}`：创建/编辑道具；  
  - `POST /loot-chests`：配置宝箱掉落；  
  - `POST /daily-quests`、`POST /season-quests`：维护每日/赛季任务；  
  - `POST /events` / `PUT /events/{id}` / `POST /events/{id}/publish`；  
  - `POST /teams/{id}/buff`：设置小队 Buff。  
- 课堂直播：`WS /live/{courseId}` 推送课堂实时事件（排行、掉落、提示）。

### 5.5 数据分析

- `GET /analytics/courses/{id}/overview`；  
- `GET /analytics/students/{id}/report`;  
- `GET /analytics/events/{eventId}`：活动数据；  
- `GET /analytics/lives/{sessionId}`：课堂战报；  
- `GET /alerts`：预警列表；  
- `POST /experiments`：创建 AB 测试并分配班级。

## 6. 关键业务逻辑

### 6.1 经验与技能计算

```
exp = base_exp * difficulty_factor * completion_factor
skill_gain = Σ(task.knowledge_tags * skill_mapping_weight)
```

- 当任务完成并达到通过条件时触发；  
- 写入 `student_skills`，如升级触发通知与动画。  
- 使用事务保证经验、技能、奖励一致。

### 6.2 过关判定流程

1. 接收提交 → 校验任务状态/截止时间；  
2. 判题服务计算客观题分，生成主观题待批阅；  
3. 计算总分，比较通过条件；  
4. 更新 `student_task_records`，写入奖励；  
5. 推送结果给学生端（WebSocket）。

### 6.3 发布与通知调度

- APScheduler 维护任务发布/截止定时；  
- 发布时更新任务状态、写入通知；  
- 截止前发送提醒；截止后自动标记未交状态。

### 6.4 地图解锁与剧情触发

1. `MapService` 根据课程任务图生成节点，节点状态 = 前置任务完成情况 + 活动加成；  
2. 当学生首次通关节点，写入 `student_map_progress`（逻辑包含在 `student_task_records` 扩展字段中）；  
3. 若节点关联剧情或彩蛋，触发 `events` 或 `storyline_scripts`（可选）并推送动画；  
4. 隐藏副本需满足条件（如完成每日任务、队伍平均星级），由后端返回新节点列表。

### 6.5 道具与宝箱使用流程

1. 学生在战斗或任务界面请求使用道具 `POST /rewards/use-item`;  
2. `InventoryService` 校验拥有数量、冷却、场景；  
3. 若通过，执行道具效果（如增加提示次数、延长时间），写入 `student_inventory` 与 `reward_logs`;  
4. 宝箱掉落：任务结算判断条件 → 从 `drop_table_json` 随机生成奖励 → 同步到背包或直接生效；  
5. 所有操作使用事务，避免奖励重复。

### 6.6 小队协作与助攻

1. 学生发起求助：`POST /assist/requests` 记录任务、步骤、描述；  
2. 队友/同班同学订阅 WebSocket 频道，收到求助提示；  
3. 助攻者提交解答（文字/语音/附件），后台写入 `assist_records`，并判定是否被采纳；  
4. 采纳后，求助者获得提示，助攻者获得助攻点与徽章，影响贡献度与排行榜；  
5. 小队任务加成：`TeamService` 定时计算团队总积分并为队员发放 Buff（如经验加成）。

### 6.7 课堂直播与实时干预

1. 教师开启 `live_sessions`，前端订阅 `WS /live/{courseId}` 渠道；  
2. 学生端定期上报阶段进度，`LiveControlService` 汇总成地图热力、排行榜变动；  
3. 教师操作（发布关卡、开启暴击、发放道具、弹幕）通过 WebSocket 推送至学生端，并写入 `live_events` 日志；  
4. 实时排行榜由 `LeaderboardService` 推送增量数据，课堂投屏组件同步渲染；  
5. 直播结束后生成课堂战报，归档到 `analytics_metrics` 与 `class_feeds`。

### 6.8 活动/每日任务/赛季流程

1. 教师在 `EventCenter` 创建活动，定义任务、奖励池、时间、适用班级；  
2. 系统生成活动任务、每日任务、赛季任务，写入 `daily_quests`、`season_quests` 并推送学生端；  
3. 学生完成任务 → `student_quests` 更新进度 → 触发奖励分发，可能调用 `reward_pools` 抽奖；  
4. 活动进度与参与率实时写入 `gamification_metrics`，供仪表盘和 AB 测试分析；  
5. 活动结束触发结算：发放赛季奖励、通行证奖励、实体奖品，更新排行榜快照并通知学生。

## 7. 前端设计要点

- **状态管理**：`pinia` 模块划分（authStore、courseStore、taskStore、gamificationStore）。  
- **路由**：  
  - `/teacher/*` 教师端；  
  - `/student/*` 学生端；  
  - `/admin/*` 系统管理。  
- **UI 组件**：使用 Ant Design Vue 或 Naive UI；地图/技能树用 svg/canvas，教师端地图编辑器支持拖拽与画布缩放。  
- **关键页面组件**：`CourseMapEditor`, `BossConfigurator`, `LiveDashboard`, `EventCenter`, `StudentWorldMap`, `BattleReport`.  
- **国际化**：i18n 预留；  
- **PWA**：缓存关键页面、离线提示。  
- **动画与音效**：世界地图、BOSS 战、奖励弹窗等使用 Lottie/WebGL，可降级为 CSS 动画；提供跳过按钮。  
- **离线/弱网体验**：战斗与提交流程支持本地缓存与重试；道具使用前端需提示幂等。  
- **可访问性**：提供键盘导航、屏幕阅读器支持。

## 8. 安全与性能

- JWT + 刷新 token；关键接口权限校验（课程/班级范围）。  
- 文件上传防止脚本注入（Mime 检测、随机文件名）。  
- API 限流（FastAPI 中间件）；  
- SQLite 读写锁策略：写操作队列化，避免锁冲突；必要时拆分读写库或迁移到 PostgreSQL。  
- 数据备份：每日复制 `ggzj.db`，保留 7 天；文件存储采用哈希命名。  
- 日志：uvicorn/access log + 业务日志（JSON），可接入 ELK；对奖励公式、活动配置、课堂直播操作进行审计与回滚。

## 9. 开发与测试计划

1. **迭代 1**：认证、课程、任务闭环（教师端 + 学生闯关基础）。  
2. **迭代 2**：题库判题、激励系统、排行榜。  
3. **迭代 3**：数据分析、通知、社交协作。  
4. **迭代 4**：学生端游戏化增强（地图、角色、技能树）。  
5. **测试**：  
   - 单元测试（pytest + coverage 80%）；  
   - 接口测试（pytest + httpx）；  
   - 前端 e2e（Cypress）；  
   - 性能压测（Locust，重点关注并发提交任务、排行榜）。  
6. **CI/CD**：GitHub Actions / GitLab CI 进行 lint、unit test、构建、镜像推送。

## 10. 未来扩展

- 数据库升级为 PostgreSQL + SQLAlchemy ORM 无缝迁移。  
- 引入消息队列（RabbitMQ）处理通知、活动奖励。  
- 接入 AI 辅助批改、题目生成。  
- 支持小程序 / App，开放第三方课程市场。  
- 结合校园 SSO、成绩系统，实现成绩回写。


