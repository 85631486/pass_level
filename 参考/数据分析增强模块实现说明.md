# 数据分析增强模块实现说明

## 概述

数据分析增强模块为教师提供了全面的学生状态监控、风险预警和教学策略优化工具。该模块包括三个核心子系统：学生画像系统、预警策略引擎和AB测试框架。

## 一、学生画像系统

### 功能特性

1. **多维度能力评估**
   - 学习能力：基于任务完成率、答题正确率、用时效率
   - 协作度：基于助攻次数、小队贡献、班级互动
   - 活跃度：基于登录频率、任务参与度、道具使用
   - 风险等级：综合未登录、失败率、下滑趋势

2. **个性化洞察建议**
   - 自动生成基于画像数据的个性化学习建议
   - 针对不同能力维度提供改进方向

3. **可视化展示**
   - 雷达图展示能力维度
   - 风险等级指示器
   - 行为时间轴

### 技术实现

- **数据模型**: `StudentPortrait`, `StudentBehaviorLog`, `RiskIndicator`
- **服务层**: `PortraitService` - 画像计算逻辑
- **API接口**: `/api/v1/analytics/students/{id}/portrait`, `/api/v1/analytics/courses/{id}/portraits`
- **前端页面**: `StudentPortrait.vue`
- **组件**: `PortraitRadar.vue`, `RiskIndicator.vue`

## 二、预警策略引擎

### 功能特性

1. **预警规则类型**
   - 未登录预警：连续N天未登录
   - 任务失败预警：连续N次失败或失败率超过阈值
   - 战斗力下滑预警：战斗力下降超过X%
   - 协作异常预警：助攻无响应、小队参与度低
   - 活跃度下降预警：活跃度指标连续下降

2. **预警管理**
   - 规则配置（条件、通知渠道、冷却时间）
   - 自动评估与触发
   - 预警处理流程（标记已读、跟进、关闭）

3. **通知渠道**
   - 站内信
   - 邮件（预留）
   - 企业微信（预留）

### 技术实现

- **数据模型**: `AlertRule`, `AlertRecord`, `AlertTemplate`
- **服务层**: `AlertService` - 预警评估与处理逻辑
- **API接口**: `/api/v1/alerts/rules`, `/api/v1/alerts/pending`, `/api/v1/alerts/{id}/handle`
- **前端页面**: `AlertCenter.vue`
- **组件**: `AlertRuleEditor.vue`, `AlertList.vue`

## 三、AB测试框架

### 功能特性

1. **实验管理**
   - 创建实验（配置分组策略、策略参数）
   - 启动/停止实验
   - 实验状态管理

2. **分组策略**
   - 随机分组
   - 哈希分组（保证一致性）
   - 平衡分组（按能力水平）

3. **指标记录与分析**
   - 记录实验指标（完成率、平均分、参与度等）
   - 对比分析
   - 统计显著性检验
   - 实验结论生成

### 技术实现

- **数据模型**: `ABTest`, `ABTestGroup`, `ABTestMetric`, `ABTestResult`
- **服务层**: `ABTestService` - 实验管理与结果计算
- **API接口**: `/api/v1/abtest/experiments`, `/api/v1/abtest/experiments/{id}/results`
- **前端页面**: `ABTestCenter.vue`
- **组件**: `ABTestWizard.vue`, `ABTestResults.vue`

## 四、定时任务

### 任务配置

1. **每日画像计算**（凌晨2点）
   - 自动计算所有学生的画像快照
   - 更新能力维度和风险等级

2. **预警评估**（每小时）
   - 评估所有激活的预警规则
   - 触发符合条件的预警

3. **AB测试指标聚合**（每小时）
   - 聚合实验指标数据
   - 更新实验结果

## 五、仪表盘增强

在教师工作台（`TeacherWorkbench.vue`）中新增：

1. **学生画像分布卡片**
   - 显示按风险等级和能力等级的学生分布
   - 快速跳转到画像详情页

2. **预警统计卡片**
   - 显示待处理预警数量
   - 按规则类型统计

3. **AB测试概览卡片**
   - 显示进行中和已完成的实验数量

## 六、API接口清单

### 画像API
- `GET /api/v1/analytics/students/{student_id}/portrait` - 获取学生画像
- `GET /api/v1/analytics/courses/{course_id}/portraits` - 批量获取课程学生画像
- `GET /api/v1/analytics/students/{student_id}/insights` - 获取学生洞察建议
- `POST /api/v1/analytics/portraits/refresh` - 刷新画像数据

### 预警API
- `GET /api/v1/alerts/rules` - 获取预警规则列表
- `POST /api/v1/alerts/rules` - 创建预警规则
- `PUT /api/v1/alerts/rules/{rule_id}` - 更新预警规则
- `DELETE /api/v1/alerts/rules/{rule_id}` - 删除预警规则
- `GET /api/v1/alerts/pending` - 获取待处理预警列表
- `POST /api/v1/alerts/{alert_id}/handle` - 处理预警
- `POST /api/v1/alerts/evaluate` - 手动触发预警评估

### AB测试API
- `GET /api/v1/abtest/experiments` - 获取AB测试实验列表
- `POST /api/v1/abtest/experiments` - 创建AB测试实验
- `PUT /api/v1/abtest/experiments/{id}` - 更新实验配置
- `POST /api/v1/abtest/experiments/{id}/start` - 启动实验
- `POST /api/v1/abtest/experiments/{id}/stop` - 停止实验
- `GET /api/v1/abtest/experiments/{id}/results` - 获取实验结果
- `GET /api/v1/abtest/students/{student_id}/group` - 获取学生实验组

### 分析统计API
- `GET /api/v1/analytics/courses/{course_id}/distribution` - 学生分布统计
- `GET /api/v1/analytics/courses/{course_id}/alerts/stats` - 预警统计
- `GET /api/v1/analytics/courses/{course_id}/abtest/overview` - AB测试概览

## 七、前端路由

新增路由：
- `/teacher/portraits` - 学生画像分析页面
- `/teacher/alerts` - 预警中心页面
- `/teacher/abtest` - AB测试中心页面

## 八、使用说明

### 查看学生画像

1. 访问 `/teacher/portraits` 页面
2. 可按风险等级筛选学生
3. 点击"查看详情"查看完整画像（雷达图、风险指示器、个性化建议）

### 配置预警规则

1. 访问 `/teacher/alerts` 页面
2. 切换到"预警规则"标签
3. 点击"新建预警规则"
4. 选择规则类型，配置触发条件和通知渠道
5. 保存后规则将自动生效

### 创建AB测试

1. 访问 `/teacher/abtest` 页面
2. 点击"新建实验"
3. 配置实验名称、分组策略、A/B组策略参数
4. 启动实验后，系统自动分配学生到不同组
5. 实验进行中可查看实时结果
6. 停止实验后可查看完整分析报告

## 九、注意事项

1. **画像计算**：首次使用需要手动触发画像计算，后续由定时任务自动更新
2. **预警触发**：预警评估每小时执行一次，也可手动触发
3. **AB测试分组**：学生分组后保持不变，确保实验一致性
4. **行为日志**：需要在实际业务逻辑中调用 `BehaviorLogService` 记录学生行为

## 十、后续优化建议

1. **画像算法优化**：根据实际数据调整权重和计算公式
2. **预警通知**：实现邮件和企业微信通知功能
3. **AB测试分析**：增强统计显著性检验的准确性
4. **行为日志自动化**：在关键业务点自动记录行为日志
5. **性能优化**：对于大量学生的画像计算，考虑异步任务和批量处理

